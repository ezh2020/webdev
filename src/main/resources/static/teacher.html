<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教师工作台 - 课程管理平台</title>

    <!-- 字体与基础样式，整体配色参考 openreview 风格（浅色背景 + 蓝色强调） -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- Markdown 富文本编辑器（vditor） -->
    <link rel="stylesheet" href="https://unpkg.com/vditor/dist/index.css">
    <script src="https://unpkg.com/vditor/dist/index.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue",
            Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background-color: #f5f7fb;
            color: #303133;
        }

        #app {
            min-height: 100vh;
        }

        .el-header {
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        .brand {
            display: flex;
            align-items: center;
        }

        .brand-logo {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            background: linear-gradient(135deg, #409eff, #6a82fb);
            margin-right: 10px;
        }

        .brand-title {
            font-size: 18px;
            font-weight: 600;
            color: #303133;
        }

        .brand-sub {
            font-size: 12px;
            color: #909399;
            margin-top: 2px;
        }

        .top-right {
            display: flex;
            align-items: center;
        }

        .top-right .el-badge {
            margin-right: 18px;
        }

        .layout-container {
            min-height: calc(100vh - 64px);
        }

        .el-aside {
            background: #ffffff;
            border-right: 1px solid #e4e7ed;
        }

        .side-menu {
            border-right: none;
        }

        .el-main {
            padding: 20px 24px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .page-title {
            font-size: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .page-title i {
            margin-right: 8px;
            color: #409eff;
        }

        .sub-title {
            font-size: 13px;
            color: #909399;
            margin-top: 2px;
        }

        .card {
            background: #ffffff;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            padding: 18px 20px;
            margin-bottom: 16px;
        }

        .flex-row {
            display: flex;
            gap: 16px;
        }

        .flex-2 {
            flex: 2;
        }

        .flex-1 {
            flex: 1;
        }

        .course-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }

        .status-open {
            background: #67c23a;
        }

        .status-closed {
            background: #f56c6c;
        }

        .vditor-container {
            border-radius: 4px;
            border: 1px solid #dcdfe6;
        }

        .metric-card {
            text-align: center;
            padding: 8px 0;
        }

        .metric-label {
            font-size: 12px;
            color: #909399;
        }

        .metric-value {
            font-size: 18px;
            font-weight: 600;
            margin-top: 4px;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            background: #f4f4f5;
            color: #606266;
        }

        .chip-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #67c23a;
            margin-right: 4px;
        }

        .trend-chart-placeholder {
            height: 220px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #909399;
            font-size: 13px;
            border: 1px dashed #ebeef5;
            border-radius: 4px;
        }

        @media (max-width: 992px) {
            .flex-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<div id="app">
    <el-container>
        <!-- 顶部导航栏 -->
        <el-header height="64px">
            <div class="brand">
                <div class="brand-logo"></div>
                <div>
                    <div class="brand-title">教师工作台</div>
                    <div class="brand-sub">Course Management · Inspired by OpenReview</div>
                </div>
            </div>
            <div class="top-right">
                <el-badge :value="unreadNotificationCount" class="item" :hidden="unreadNotificationCount===0">
                    <el-button type="text" @click="switchTab('notifications')">
                        <i class="el-icon-bell"></i>
                        通知
                    </el-button>
                </el-badge>
                <el-dropdown>
                    <span class="el-dropdown-link">
                        <i class="el-icon-user"></i>
                        {{ currentUser ? currentUser.realName || currentUser.username : '未登录' }}
                        <i class="el-icon-arrow-down el-icon--right"></i>
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item @click.native="switchTab('profile')">个人中心</el-dropdown-item>
                        <el-dropdown-item divided @click.native="logout">退出登录</el-dropdown-item>
                    </el-dropdown-menu>
                </el-dropdown>
            </div>
        </el-header>

        <el-container class="layout-container">
            <!-- 左侧菜单 -->
            <el-aside width="210px">
                <el-menu
                        class="side-menu"
                        :default-active="activeTab"
                        @select="handleMenuSelect"
                        background-color="#ffffff"
                        text-color="#303133"
                        active-text-color="#409eff">
                    <el-menu-item index="dashboard">
                        <i class="el-icon-data-analysis"></i>
                        <span slot="title">总览</span>
                    </el-menu-item>
                    <el-menu-item index="courses">
                        <i class="el-icon-notebook-2"></i>
                        <span slot="title">我的课程</span>
                    </el-menu-item>
                    <el-menu-item index="assignments">
                        <i class="el-icon-edit-outline"></i>
                        <span slot="title">作业管理</span>
                    </el-menu-item>
                    <el-menu-item index="notifications">
                        <i class="el-icon-bell"></i>
                        <span slot="title">通知中心</span>
                    </el-menu-item>
                    <el-menu-item index="profile">
                        <i class="el-icon-user"></i>
                        <span slot="title">个人中心</span>
                    </el-menu-item>
                </el-menu>
            </el-aside>

            <!-- 主内容区 -->
            <el-main>
                <!-- 仪表盘 -->
                <section v-if="activeTab === 'dashboard'">
                    <div class="page-header">
                        <div>
                            <div class="page-title">
                                <i class="el-icon-data-analysis"></i>
                                教师总览
                            </div>
                            <div class="sub-title">
                                快速了解你的课程、作业与学生情况。
                            </div>
                        </div>
                    </div>

                    <div class="flex-row">
                        <div class="flex-2">
                            <div class="card">
                                <div class="course-list-header">
                                    <div>
                                        <span style="font-weight:500">我的课程</span>
                                        <span class="sub-title" style="margin-left:6px">
                                            共 {{ courses.length }} 门课
                                        </span>
                                    </div>
                                    <el-button type="primary" size="mini" icon="el-icon-plus"
                                               @click="openCourseDialog(null)">
                                        发布新课程
                                    </el-button>
                                </div>
                                <el-table
                                        :data="courses"
                                        size="small"
                                        stripe
                                        @row-click="handleCourseRowClick">
                                    <el-table-column prop="courseCode" label="课程代码" width="120"/>
                                    <el-table-column prop="courseName" label="课程名称"/>
                                    <el-table-column label="容量 / 余量" width="140">
                                        <template slot-scope="scope">
                                            <span>{{ scope.row.currentStudents || 0 }} /
                                                {{ scope.row.maxStudents || 0 }}</span>
                                            <el-tag size="mini" type="success" v-if="getRemain(scope.row) > 0"
                                                    style="margin-left:6px">
                                                余 {{ getRemain(scope.row) }}
                                            </el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="credit" label="学分" width="80"/>
                                    <el-table-column prop="semester" label="学期" width="120"/>
                                </el-table>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="card">
                                <div style="font-weight:500;margin-bottom:8px;">关键指标</div>
                                <div class="flex-row">
                                    <div class="flex-1 metric-card">
                                        <div class="metric-label">课程数量</div>
                                        <div class="metric-value">{{ courses.length }}</div>
                                    </div>
                                    <div class="flex-1 metric-card">
                                        <div class="metric-label">作业数量</div>
                                        <div class="metric-value">{{ dashboardMetrics.assignmentCount }}</div>
                                    </div>
                                    <div class="flex-1 metric-card">
                                        <div class="metric-label">通知数量</div>
                                        <div class="metric-value">{{ notifications.length }}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div style="font-weight:500;margin-bottom:8px;">通知摘要</div>
                                <el-timeline v-if="notifications && notifications.length">
                                    <el-timeline-item
                                            v-for="n in notifications.slice(0,5)"
                                            :key="n.id"
                                            :timestamp="n.publishTime"
                                            :type="n.isImportant ? 'danger' : 'primary'"
                                            placement="top">
                                        <div style="font-size:13px;font-weight:500">{{ n.title }}</div>
                                        <div class="sub-title">{{ n.content | ellipsis(42) }}</div>
                                    </el-timeline-item>
                                </el-timeline>
                                <div v-else class="sub-title">暂无通知</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 我的课程 -->
                <section v-if="activeTab === 'courses'">
                    <div class="page-header">
                        <div>
                            <div class="page-title">
                                <i class="el-icon-notebook-2"></i>
                                我的课程
                            </div>
                            <div class="sub-title">
                                查看/编辑你发布的课程，管理选课学生。
                            </div>
                        </div>
                        <div>
                            <el-button type="primary" size="small" icon="el-icon-plus"
                                       @click="openCourseDialog(null)">
                                发布课程
                            </el-button>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom:16px;">
                        <el-form :inline="true" :model="courseFilter" size="small">
                            <el-form-item label="学期">
                                <el-input v-model="courseFilter.semester" placeholder="例如 2023-2024-1" clearable/>
                            </el-form-item>
                            <el-form-item label="学分区间">
                                <el-input-number v-model="courseFilter.minCredit" :min="0" :max="20" controls-position="right"/>
                                <span style="margin:0 6px;">~</span>
                                <el-input-number v-model="courseFilter.maxCredit" :min="0" :max="20" controls-position="right"/>
                            </el-form-item>
                            <el-form-item label="最小余量">
                                <el-input-number v-model="courseFilter.minRemain" :min="0" :max="500" controls-position="right"/>
                            </el-form-item>
                            <el-form-item label="排序">
                                <el-select v-model="courseFilter.sortBy" style="width:140px" clearable>
                                    <el-option label="按创建时间" value="time"/>
                                    <el-option label="按学分" value="credit"/>
                                    <el-option label="按余量" value="remain"/>
                                </el-select>
                                <el-select v-model="courseFilter.sortOrder" style="width:120px;margin-left:6px;">
                                    <el-option label="降序" value="desc"/>
                                    <el-option label="升序" value="asc"/>
                                </el-select>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" icon="el-icon-search" @click="searchCourses">筛选</el-button>
                                <el-button @click="resetCourseFilter" icon="el-icon-refresh">重置</el-button>
                            </el-form-item>
                        </el-form>
                    </div>

                    <div class="flex-row">
                        <div class="flex-2">
                            <div class="card">
                                <el-table
                                        :data="courses"
                                        @row-click="handleCourseRowClick"
                                        highlight-current-row>
                                    <el-table-column type="index" width="50"/>
                                    <el-table-column prop="courseCode" label="课程代码" width="120"/>
                                    <el-table-column prop="courseName" label="课程名称"/>
                                    <el-table-column prop="credit" label="学分" width="70"/>
                                    <el-table-column label="容量/余量" width="120">
                                        <template slot-scope="scope">
                                            {{ scope.row.currentStudents || 0 }}/{{ scope.row.maxStudents || 0 }}
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="semester" label="学期" width="120"/>
                                    <el-table-column label="操作" width="190">
                                        <template slot-scope="scope">
                                            <el-button type="text" size="mini"
                                                       @click.stop="openCourseDialog(scope.row)">编辑</el-button>
                                            <el-button type="text" size="mini"
                                                       @click.stop="openCourseDescription(scope.row)">简介</el-button>
                                            <el-button type="text" size="mini" style="color:#f56c6c"
                                                       @click.stop="deleteCourse(scope.row)">删除</el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="card">
                                <div class="course-list-header">
                                    <span style="font-weight:500">选课名单</span>
                                    <div v-if="selectedCourse">
                                        <span class="chip">
                                            <span class="chip-dot"></span>
                                            {{ selectedCourse.courseName }} 的学生
                                        </span>
                                    </div>
                                </div>
                                <el-table v-if="selectedCourseSelections.length"
                                          :data="selectedCourseSelections"
                                          size="small"
                                          height="360">
                                    <el-table-column prop="studentId" label="学生ID" width="120"/>
                                    <el-table-column prop="status" label="状态" width="120"/>
                                    <el-table-column prop="finalScore" label="期末成绩" width="100"/>
                                </el-table>
                                <div v-else class="sub-title">请选择左侧课程查看实时选课名单。</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 作业管理 -->
                <section v-if="activeTab === 'assignments'">
                    <div class="page-header">
                        <div>
                            <div class="page-title">
                                <i class="el-icon-edit-outline"></i>
                                作业管理
                            </div>
                            <div class="sub-title">
                                按课程发布/修改/删除作业，查看成绩分布与趋势。
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <el-form :inline="true" size="small">
                            <el-form-item label="选择课程">
                                <el-select v-model="assignmentCourseId" placeholder="选择一门课程" style="width:260px"
                                           @change="loadAssignmentsForCourse">
                                    <el-option
                                            v-for="c in courses"
                                            :key="c.id"
                                            :label="c.courseName + ' (' + c.courseCode + ')'"
                                            :value="c.id"/>
                                </el-select>
                            </el-form-item>
                            <el-form-item v-if="assignmentCourseId">
                                <el-button type="primary" size="small" icon="el-icon-plus"
                                           @click="openAssignmentDialog(null)">
                                    发布作业
                                </el-button>
                            </el-form-item>
                        </el-form>
                    </div>

                    <div class="flex-row" v-if="assignmentCourseId">
                        <div class="flex-2">
                            <div class="card">
                                <div class="course-list-header">
                                    <span style="font-weight:500">作业列表</span>
                                </div>
                                <el-table
                                        :data="assignments"
                                        @row-click="handleAssignmentRowClick"
                                        highlight-current-row
                                        size="small">
                                    <el-table-column type="index" width="50"/>
                                    <el-table-column prop="title" label="标题"/>
                                    <el-table-column prop="maxScore" label="满分" width="80"/>
                                    <el-table-column prop="deadline" label="截止时间" width="180"/>
                                    <el-table-column label="操作" width="200">
                                        <template slot-scope="scope">
                                            <el-button type="text" size="mini"
                                                       @click.stop="openAssignmentDialog(scope.row)">编辑
                                            </el-button>
                                            <el-button type="text" size="mini"
                                                       @click.stop="deleteAssignment(scope.row)">删除</el-button>
                                            <el-button type="text" size="mini"
                                                       @click.stop="loadSubmissions(scope.row)">成绩</el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="card">
                                <div class="course-list-header">
                                    <span style="font-weight:500">成绩统计</span>
                                </div>
                                <el-table
                                        v-if="currentSubmissions.length"
                                        :data="currentSubmissions"
                                        size="small"
                                        height="220">
                                    <el-table-column prop="studentId" label="学生ID" width="110"/>
                                    <el-table-column prop="score" label="分数" width="80"/>
                                    <el-table-column prop="status" label="状态" width="100"/>
                                </el-table>
                                <div v-else class="sub-title">选择一份作业查看提交与成绩。</div>

                                <div style="margin-top:12px;">
                                    <div class="trend-chart-placeholder">
                                        成绩趋势图 / 排名图可在此引入图表库（例如 ECharts），
                                        当前示例仅为占位。
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 通知中心 -->
                <section v-if="activeTab === 'notifications'">
                    <div class="page-header">
                        <div>
                            <div class="page-title">
                                <i class="el-icon-bell"></i>
                                通知中心
                            </div>
                            <div class="sub-title">
                                选课成功 / 退课 / 成绩发布 等通知，可以在此查看。
                                WebSocket 实时推送在前端已预留接口，需后端配合。
                            </div>
                        </div>
                    </div>

                    <div class="flex-row">
                        <div class="flex-2">
                            <div class="card">
                                <el-timeline v-if="notifications.length">
                                    <el-timeline-item
                                            v-for="n in notifications"
                                            :key="n.id"
                                            :timestamp="n.publishTime"
                                            :type="n.isImportant ? 'danger' : 'primary'">
                                        <h4>{{ n.title }}</h4>
                                        <p style="font-size:13px;color:#606266;margin-top:4px;">
                                            {{ n.content }}
                                        </p>
                                        <p class="sub-title" style="margin-top:4px;">
                                            课程ID: {{ n.courseId || '系统' }} · 发布人: {{ n.publisherId }}
                                        </p>
                                    </el-timeline-item>
                                </el-timeline>
                                <div v-else class="sub-title">暂无通知。</div>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="card">
                                <div style="font-weight:500;margin-bottom:8px;">WebSocket 连接状态</div>
                                <p class="sub-title">
                                    当前状态：{{ wsStatus }}
                                </p>
                                <el-button size="mini" @click="initWebSocket">重新连接</el-button>
                                <p class="sub-title" style="margin-top:12px;">
                                    注意：需要后端提供 WebSocket 服务端（例如 /ws/notification），
                                    前端已通过 <code>new WebSocket()</code> 预留接入点。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 个人中心 -->
                <section v-if="activeTab === 'profile'">
                    <div class="page-header">
                        <div>
                            <div class="page-title">
                                <i class="el-icon-user"></i>
                                个人中心
                            </div>
                            <div class="sub-title">
                                修改个人资料与任教信息。注意：这里只能更新信息，不能从数据库“删除条目”。
                            </div>
                        </div>
                    </div>

                    <div class="flex-row">
                        <div class="flex-2">
                            <div class="card">
                                <div style="font-weight:500;margin-bottom:12px;">基础信息</div>
                                <el-form :model="profileForm" label-width="90px">
                                    <el-form-item label="用户ID">
                                        <el-input v-model="profileForm.userId" disabled></el-input>
                                    </el-form-item>
                                    <el-form-item label="用户名">
                                        <el-input v-model="profileForm.username" disabled></el-input>
                                    </el-form-item>
                                    <el-form-item label="真实姓名">
                                        <el-input v-model="profileForm.realName"></el-input>
                                    </el-form-item>
                                    <el-form-item label="邮箱">
                                        <el-input v-model="profileForm.email"></el-input>
                                    </el-form-item>
                                    <el-form-item label="手机号">
                                        <el-input v-model="profileForm.phone"></el-input>
                                    </el-form-item>
                                </el-form>
                            </div>

                            <div class="card">
                                <div style="font-weight:500;margin-bottom:12px;">任教信息</div>
                                <el-form :model="profileForm" label-width="90px">
                                    <el-form-item label="教师工号">
                                        <el-input v-model="profileForm.teacherId"></el-input>
                                    </el-form-item>
                                    <el-form-item label="所属院系">
                                        <el-input v-model="profileForm.department"></el-input>
                                    </el-form-item>
                                    <el-form-item label="职称">
                                        <el-input v-model="profileForm.title"></el-input>
                                    </el-form-item>
                                    <el-form-item label="办公室">
                                        <el-input v-model="profileForm.office"></el-input>
                                    </el-form-item>
                                    <el-form-item>
                                        <el-button type="primary" @click="updateProfile">保存修改</el-button>
                                        <el-button @click="loadProfile">重置</el-button>
                                    </el-form-item>
                                </el-form>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="card">
                                <div style="font-weight:500;margin-bottom:12px;">会话与权限</div>
                                <p class="sub-title">
                                    当前登录方式为后端 Session。
                                    你计划使用 JWT 或 Redis 会话时，可以在前端：
                                </p>
                                <ul class="sub-title" style="margin-left:16px;margin-top:6px;line-height:1.8;">
                                    <li>在登录接口响应中保存 <code>accessToken</code> / <code>refreshToken</code> 到内存或安全存储；</li>
                                    <li>通过 Axios 拦截器在每次请求的 Header 中附加 <code>Authorization: Bearer &lt;token&gt;</code>；</li>
                                    <li>使用 <code>lastActiveTime</code> 记录最近操作时间，超过 30 分钟自动退出；</li>
                                    <li>收到后端 401/403 响应时，清理本地令牌并跳转到登录页。</li>
                                </ul>
                                <p class="sub-title" style="margin-top:8px;">
                                    这些都是前端能力，需要后端新增 JWT 登录接口和 Redis 会话支持后即可落地。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>
            </el-main>
        </el-container>

        <!-- 课程简介编辑对话框 -->
        <el-dialog
                title="编辑课程简介"
                :visible.sync="descriptionDialogVisible"
                width="60%">
            <div id="vditor" class="vditor-container"></div>
            <span slot="footer" class="dialog-footer">
                <el-button @click="descriptionDialogVisible = false">取 消</el-button>
                <el-button type="primary" @click="saveCourseDescription()">保 存</el-button>
            </span>
        </el-dialog>
    </el-container>
</div>

<script>
    // Axios 全局配置：基地址 + 简单错误处理
    axios.defaults.baseURL = '/api';

    new Vue({
        el: '#app',
        data() {
            return {
                activeTab: 'dashboard',
                currentUser: null,

                // 课程相关
                courses: [],
                courseFilter: {
                    semester: '',
                    minCredit: null,
                    maxCredit: null,
                    minRemain: null,
                    sortBy: 'time',
                    sortOrder: 'desc'
                },
                selectedCourse: null,
                selectedCourseSelections: [],

                // 作业相关
                assignmentCourseId: null,
                assignments: [],
                currentSubmissions: [],

                // 通知
                notifications: [],
                unreadNotificationCount: 0,
                ws: null,
                wsStatus: '未连接',

                // 个人中心
                profileForm: {
                    userId: null,
                    username: '',
                    realName: '',
                    email: '',
                    phone: '',
                    teacherId: '',
                    department: '',
                    title: '',
                    office: ''
                },

                // 仪表盘指标（可根据需要拓展）
                dashboardMetrics: {
                    assignmentCount: 0
                },

                // 课程简介富文本
                descriptionDialogVisible: false,
                descriptionCourse: null,
                vditor: null
            };
        },
        filters: {
            ellipsis(value, length) {
                if (!value) return '';
                if (value.length <= length) return value;
                return value.substr(0, length) + '...';
            }
        },
        methods: {
            switchTab(tab) {
                this.activeTab = tab;
            },
            handleMenuSelect(index) {
                this.activeTab = index;
            },

            // 课程余量
            getRemain(course) {
                const max = course.maxStudents || 0;
                const cur = course.currentStudents || 0;
                return Math.max(max - cur, 0);
            },

            // 加载当前用户信息
            loadCurrentUser() {
                axios.get('/user/me').then(res => {
                    if (res.data && res.data.code === 1) {
                        this.currentUser = res.data.data;
                        this.loadProfile();
                        this.loadCourses();
                        this.loadNotifications();
                    } else {
                        this.$message.error(res.data.msg || '请先登录');
                    }
                }).catch(() => {
                    this.$message.error('获取当前用户失败');
                });
            },

            // 课程列表（只看自己的课程）
            loadCourses() {
                if (!this.currentUser) return;
                // 这里假设 course.teacherId == user.id，如有需要可根据你的实际表结构调整
                axios.get('/course/listByTeacher', {
                    params: {teacherId: this.currentUser.id}
                }).then(res => {
                    if (res.data && res.data.code === 1) {
                        this.courses = res.data.data || [];
                        this.dashboardMetrics.assignmentCount = 0; // 简化处理，可后续通过接口统计
                    }
                });
            },

            // 课程搜索（多条件组合筛选）
            searchCourses() {
                const req = {
                    semester: this.courseFilter.semester || null,
                    minCredit: this.courseFilter.minCredit,
                    maxCredit: this.courseFilter.maxCredit,
                    minRemain: this.courseFilter.minRemain,
                    sortBy: this.courseFilter.sortBy,
                    sortOrder: this.courseFilter.sortOrder
                };
                axios.post('/course/search', req).then(res => {
                    if (res.data && res.data.code === 1) {
                        // 注意：search 是全局课程，如果只希望显示当前老师的课程，可在前端再过滤
                        const all = res.data.data || [];
                        const teacherId = this.currentUser ? this.currentUser.id : null;
                        this.courses = teacherId
                            ? all.filter(c => c.teacherId === teacherId)
                            : all;
                    }
                });
            },

            resetCourseFilter() {
                this.courseFilter = {
                    semester: '',
                    minCredit: null,
                    maxCredit: null,
                    minRemain: null,
                    sortBy: 'time',
                    sortOrder: 'desc'
                };
                this.loadCourses();
            },

            // 选中课程 -> 加载选课名单
            handleCourseRowClick(row) {
                this.selectedCourse = row;
                if (!row || !row.id) {
                    this.selectedCourseSelections = [];
                    return;
                }
                axios.get('/courseSelection/listByCourse', {
                    params: {courseId: row.id}
                }).then(res => {
                    if (res.data && res.data.code === 1) {
                        this.selectedCourseSelections = res.data.data || [];
                    } else {
                        this.selectedCourseSelections = [];
                    }
                });
            },

            // 发布/编辑课程（这里简单用 prompt；实际可以做成弹窗表单）
            openCourseDialog(course) {
                const isEdit = !!course;
                const title = isEdit ? '编辑课程标题（仅示例）' : '新课程标题（仅示例）';
                this.$prompt(title, '课程', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    inputValue: course ? course.courseName : ''
                }).then(({value}) => {
                    if (!value) return;
                    let payload = Object.assign({}, course || {});
                    payload.courseName = value;
                    if (!isEdit) {
                        payload.teacherId = this.currentUser.id;
                        axios.post('/course/add', payload).then(res => {
                            if (res.data && res.data.code === 1) {
                                this.$message.success('课程创建成功');
                                this.loadCourses();
                            } else {
                                this.$message.error(res.data.msg || '创建课程失败');
                            }
                        });
                    } else {
                        axios.post('/course/update', payload).then(res => {
                            if (res.data && res.data.code === 1) {
                                this.$message.success('课程更新成功');
                                this.loadCourses();
                            } else {
                                this.$message.error(res.data.msg || '更新课程失败');
                            }
                        });
                    }
                }).catch(() => {
                });
            },

            deleteCourse(course) {
                this.$confirm('确定删除该课程吗？已选课学生将无法再访问该课程。', '提示', {
                    type: 'warning'
                }).then(() => {
                    axios.delete('/course/' + course.id).then(res => {
                        if (res.data && res.data.code === 1) {
                            this.$message.success('删除成功');
                            this.loadCourses();
                        } else {
                            this.$message.error(res.data.msg || '删除失败');
                        }
                    });
                }).catch(() => {
                });
            },

            // 课程简介编辑（Markdown 富文本）
            openCourseDescription(course) {
                this.descriptionCourse = course;
                this.descriptionDialogVisible = true;
                this.$nextTick(() => {
                    if (!this.vditor) {
                        this.vditor = new Vditor('vditor', {
                            height: 320,
                            placeholder: '在此编辑课程简介（支持 Markdown & 代码高亮）',
                            mode: 'ir',
                            cache: {
                                enable: false
                            }
                        });
                    }
                    this.vditor.setValue(course.description || '');
                });
            },

            saveCourseDescription() {
                if (!this.descriptionCourse) return;
                const content = this.vditor ? this.vditor.getValue() : '';
                const payload = Object.assign({}, this.descriptionCourse, {description: content});
                axios.post('/course/update', payload).then(res => {
                    if (res.data && res.data.code === 1) {
                        this.$message.success('课程简介已保存');
                        this.descriptionDialogVisible = false;
                        this.loadCourses();
                    } else {
                        this.$message.error(res.data.msg || '保存失败');
                    }
                });
            },

            // 作业管理
            loadAssignmentsForCourse(courseId) {
                if (!courseId) {
                    this.assignments = [];
                    return;
                }
                axios.get('/assignment/listByCourseAndDeadline', {
                    params: {courseId: courseId}
                }).then(res => {
                    if (res.data && res.data.code === 1) {
                        this.assignments = res.data.data || [];
                    } else {
                        this.assignments = [];
                    }
                });
            },

            handleAssignmentRowClick(row) {
                this.loadSubmissions(row);
            },

            openAssignmentDialog(assignment) {
                const isEdit = !!assignment;
                const title = isEdit ? '编辑作业标题（仅示例）' : '新作业标题（仅示例）';
                this.$prompt(title, '作业', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    inputValue: assignment ? assignment.title : ''
                }).then(({value}) => {
                    if (!value) return;
                    let payload = Object.assign({}, assignment || {});
                    payload.title = value;
                    payload.courseId = this.assignmentCourseId;
                    if (!isEdit) {
                        axios.post('/assignment/add', payload).then(res => {
                            if (res.data && res.data.code === 1) {
                                this.$message.success('作业创建成功');
                                this.loadAssignmentsForCourse(this.assignmentCourseId);
                            } else {
                                this.$message.error(res.data.msg || '创建作业失败');
                            }
                        });
                    } else {
                        axios.post('/assignment/update', payload).then(res => {
                            if (res.data && res.data.code === 1) {
                                this.$message.success('作业更新成功');
                                this.loadAssignmentsForCourse(this.assignmentCourseId);
                            } else {
                                this.$message.error(res.data.msg || '更新作业失败');
                            }
                        });
                    }
                }).catch(() => {
                });
            },

            deleteAssignment(assignment) {
                this.$confirm('确定删除该作业吗？对应提交记录不会自动删除。', '提示', {
                    type: 'warning'
                }).then(() => {
                    axios.delete('/assignment/' + assignment.id).then(res => {
                        if (res.data && res.data.code === 1) {
                            this.$message.success('删除成功');
                            this.loadAssignmentsForCourse(this.assignmentCourseId);
                        } else {
                            this.$message.error(res.data.msg || '删除失败');
                        }
                    });
                }).catch(() => {
                });
            },

            // 加载某项作业的提交与成绩
            loadSubmissions(assignment) {
                if (!assignment || !assignment.id) return;
                axios.get('/assignmentSubmission/listByAssignment', {
                    params: {assignmentId: assignment.id}
                }).then(res => {
                    if (res.data && res.data.code === 1) {
                        this.currentSubmissions = res.data.data || [];
                    } else {
                        this.currentSubmissions = [];
                    }
                });
            },

            // 通知
            loadNotifications() {
                axios.get('/notification/listAll').then(res => {
                    if (res.data && res.data.code === 1) {
                        this.notifications = res.data.data || [];
                        this.unreadNotificationCount = this.notifications.length;
                    }
                });
            },

            // WebSocket 通知（需后端实现 /ws/notification）
            initWebSocket() {
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
                try {
                    // 根据实际部署地址调整 ws:// 主机和路径
                    const url = (location.protocol === 'https:' ? 'wss://' : 'ws://')
                        + location.host + '/ws/notification';
                    this.ws = new WebSocket(url);
                    this.wsStatus = '连接中...';
                    this.ws.onopen = () => {
                        this.wsStatus = '已连接';
                    };
                    this.ws.onmessage = (event) => {
                        // 约定后端推送 JSON：{ type: 'ENROLL'|'DROP'|'GRADE', message: '...', time: '...' }
                        try {
                            const msg = JSON.parse(event.data);
                            this.$notify({
                                title: '新通知',
                                message: msg.message || '有新的选课/成绩变动',
                                type: 'info'
                            });
                            this.unreadNotificationCount += 1;
                            // 可根据需要刷新通知列表
                            this.loadNotifications();
                        } catch (e) {
                            console.log('WS message:', event.data);
                        }
                    };
                    this.ws.onclose = () => {
                        this.wsStatus = '未连接';
                    };
                    this.ws.onerror = () => {
                        this.wsStatus = '连接出错';
                    };
                } catch (e) {
                    this.wsStatus = '浏览器不支持 WebSocket';
                }
            },

            // 个人中心
            loadProfile() {
                if (!this.currentUser) return;
                this.profileForm.userId = this.currentUser.id;
                this.profileForm.username = this.currentUser.username;
                this.profileForm.realName = this.currentUser.realName || '';
                this.profileForm.email = this.currentUser.email || '';
                this.profileForm.phone = this.currentUser.phone || '';
                // 教师扩展信息需要通过后端 Teacher 表查询，这里假设可以用 updateProfile 接口补全
            },

            updateProfile() {
                if (!this.profileForm.userId) {
                    this.$message.error('未获取到用户ID');
                    return;
                }
                const req = {
                    userId: this.profileForm.userId,
                    realName: this.profileForm.realName,
                    email: this.profileForm.email,
                    phone: this.profileForm.phone,
                    teacherId: this.profileForm.teacherId,
                    department: this.profileForm.department,
                    title: this.profileForm.title,
                    office: this.profileForm.office
                };
                axios.post('/teacher/updateProfile', req).then(res => {
                    if (res.data && res.data.code === 1) {
                        this.$message.success('个人资料已更新');
                        this.loadCurrentUser();
                    } else {
                        this.$message.error(res.data.msg || '更新失败');
                    }
                });
            },

            // 退出登录
            logout() {
                axios.post('/user/logout').then(() => {
                    this.currentUser = null;
                    this.$message.success('已退出登录');
                    // 实际使用中可跳转到登录页
                });
            }
        },
        mounted() {
            this.loadCurrentUser();
            this.initWebSocket();
        }
    });
</script>
</body>
</html>
