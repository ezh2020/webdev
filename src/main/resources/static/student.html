<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>webdev - 学生端</title>

    <!-- UI / 前端依赖，与 teacher.html 保持一致 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/vue-i18n@8/dist/vue-i18n.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- Markdown 富文本预览（用于课程简介） -->
    <link rel="stylesheet" href="https://unpkg.com/vditor/dist/index.css">
    <script src="https://unpkg.com/vditor/dist/index.min.js"></script>

    
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
	        body{
	            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,
	            "PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
	            background:#f2f2f2;
	            color:#202124;
	        }
	        #app{min-height:100vh;}

	        .el-header{
	            background: linear-gradient(0deg, #7d1b1b, #651616);
	            color: #ffffff;
	            border-bottom:1px solid rgba(255,255,255,0.10);
	            display:flex;
	            align-items:center;
	            justify-content:space-between;
	            padding:0 24px;
	            box-shadow:none!important;
	        }
	        .brand {
	            display: flex;
	            align-items: center;
	        }
	        .brand-logo {
	            display: none;
	        }
	        .brand-title {
	            font-size: 20px;
	            font-weight: 700;
	            letter-spacing:.2px;
	            color: #ffffff;
	        }
	        .brand-sub {
	            font-size: 12px;
	            color: rgba(255,255,255,0.78);
	            margin-top: 2px;
	        }

	        .top-right {
	            display: flex;
	            align-items: center;
	        }
	        .top-right .el-badge {
	            margin-right: 18px;
	        }
	        .top-right .el-button--text,
	        .top-right .el-dropdown-link,
	        .top-right i{
	            color:#ffffff!important;
	        }
	        .top-right .el-button--text:hover,
	        .top-right .el-dropdown-link:hover{
	            color:rgba(255,255,255,0.88)!important;
	        }

	        .subbar{
	            height: 44px;
	            background:#e6e6e6;
	            border-bottom:1px solid #d0d0d0;
	            padding:0 12px;
	            display:flex;
	            align-items:center;
	        }
        .top-menu{
            background:transparent!important;
            border-bottom:none!important;
        }
	        .top-menu.el-menu--horizontal>.el-menu-item{
	            height:44px;line-height:44px;
	            border-bottom:2px solid transparent;
	            padding:0 14px;
	            font-weight:600;
	        }
	        .top-menu.el-menu--horizontal>.el-menu-item.is-active{
	            border-bottom-color:#2f6f9f;
	            background:transparent!important;
	        }
        .top-menu.el-menu--horizontal>.el-menu-item:hover{
            background:rgba(0,0,0,.03)!important;
        }

        .webdev-main{padding:18px 18px 28px;}
        .page-header{margin:8px 0 12px;}
        .page-title{
            font-size:26px;
            font-weight:650;
            color:#1f1f1f;
            display:flex;
            align-items:center;
            gap:10px;
        }
        .page-title i{color:#8b1c1c;margin-right:0;}
        .sub-title{font-size:13px;color:#6b7280;margin-top:6px;}

        .card{
            background:transparent;
            border:none;
            border-radius:0;
            box-shadow:none;
            padding:0;
            margin:0 0 14px;
        }

        .el-table{
            background:transparent;
            border:1px solid #e0e0e0;
        }
        .el-table th{
            background:#efefef!important;
            color:#333;
        }
        .el-table tr{background:transparent;}
        .el-table--striped .el-table__body tr.el-table__row--striped td{
            background:rgba(0,0,0,.015);
        }

        .el-input__inner,.el-textarea__inner{border-radius:2px;}
        .course-desc-preview{
            border:1px solid #e0e0e0;
            border-radius:0;
            padding:12px;
            min-height:140px;
            background:transparent;
            overflow:auto;
        }

        .el-dialog{border-radius:0;box-shadow:none;}
        .el-dialog__header{border-bottom:1px solid #eaeaea;}
        .status-tag{font-size:12px;}
	        .flex-row{display:flex;gap:16px;}
	        .flex-2{flex:2;}
	        .flex-1{flex:1;}
	    </style>
    
</head>
<body>
<div id="app">
    <el-container>
        <!-- 顶部导航栏 -->
	        <el-header height="64px">
	            <div class="brand">
	                <div class="brand-logo"></div>
	                <div>
	                    <div class="brand-title">{{ $t('app.brand') }}</div>
	                    <div class="brand-sub">{{ $t('student.headerSub') }}</div>
	                </div>
	            </div>
	            <div class="top-right">
                <el-badge :value="unreadNotificationCount" class="item" :hidden="unreadNotificationCount===0">
                    <el-button type="text" @click="switchTab('notifications')">
                        <i class="el-icon-bell"></i>
                        {{ $t('student.notifications') }}
                    </el-button>
                </el-badge>
                <el-dropdown>
                    <span class="el-dropdown-link">
                        <i class="el-icon-user"></i>
                        {{ currentUser ? currentUser.realName || currentUser.username : $t('common.notLoggedIn') }}
                        <i class="el-icon-arrow-down el-icon--right"></i>
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item @click.native="switchTab('profile')">{{ $t('student.menuProfile') }}</el-dropdown-item>
                        <el-dropdown-item divided @click.native="logout">{{ $t('student.menuLogout') }}</el-dropdown-item>
                    </el-dropdown-menu>
                </el-dropdown>
                <el-select v-model="locale"
                           size="mini"
                           @change="switchLocale"
                           style="width: 110px;margin-left:12px;">
                    <el-option label="中文" value="zh"></el-option>
                    <el-option label="English" value="en"></el-option>
                </el-select>
            </div>
        </el-header>

        
	        <div class="subbar">
 	            <el-menu mode="horizontal"
 	                        class="top-menu"
 	                        :default-active="activeTab"
	                        @select="handleMenuSelect"
	                        background-color="transparent"
	                        text-color="#2f6f9f"
	                        active-text-color="#2f6f9f">
 	                    <el-menu-item index="courses">
 	                        <i class="el-icon-notebook-1"></i>
 	                        <span slot="title">{{ $t('student.navCourses') }}</span>
 	                    </el-menu-item>
                    <el-menu-item index="myCourses">
                        <i class="el-icon-reading"></i>
                        <span slot="title">{{ $t('student.navMyCourses') }}</span>
                    </el-menu-item>
                    <el-menu-item index="assignments">
                        <i class="el-icon-edit-outline"></i>
                        <span slot="title">{{ $t('student.navAssignments') }}</span>
                    </el-menu-item>
                    <el-menu-item index="notifications">
                        <i class="el-icon-bell"></i>
                        <span slot="title">{{ $t('student.navNotifications') }}</span>
                    </el-menu-item>
                    <el-menu-item index="profile">
                        <i class="el-icon-user"></i>
                        <span slot="title">{{ $t('student.navProfile') }}</span>
                    </el-menu-item>
                </el-menu>
        </div>
    
        <el-main class="webdev-main">
                <!-- 课程中心 -->
                <section v-if="activeTab === 'courses'">
                    <div class="page-header">
                        <div>
                            <div class="page-title">
                                <i class="el-icon-notebook-1"></i>
                                课程中心
                            </div>
                            <div class="sub-title">
                                查看所有可选课程，按学分/余量/时间筛选；在列表中直接选课。
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <el-form :inline="true" :model="courseFilter" label-width="80px">
                            <el-form-item label="学期">
                                <el-input v-model="courseFilter.semester" placeholder="例如 2023-2024-1" size="small"></el-input>
                            </el-form-item>
                            <el-form-item label="学分">
                                <el-input-number v-model="courseFilter.minCredit" :min="0" :max="20" size="small"
                                                 placeholder="最小"></el-input-number>
                                <span style="margin: 0 4px;">-</span>
                                <el-input-number v-model="courseFilter.maxCredit" :min="0" :max="20" size="small"
                                                 placeholder="最大"></el-input-number>
                            </el-form-item>
                            <el-form-item label="最小余量">
                                <el-input-number v-model="courseFilter.minRemain" :min="0" :max="999" size="small"></el-input-number>
                            </el-form-item>
                            <el-form-item label="排序">
                                <el-select v-model="courseFilter.sortBy" size="small" style="width: 120px;">
                                    <el-option label="按时间" value="time"></el-option>
                                    <el-option label="按学分" value="credit"></el-option>
                                    <el-option label="按余量" value="remain"></el-option>
                                </el-select>
                                <el-select v-model="courseFilter.sortOrder" size="small" style="width: 120px; margin-left: 4px;">
                                    <el-option label="降序" value="desc"></el-option>
                                    <el-option label="升序" value="asc"></el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" size="small" @click="searchCourses">搜索</el-button>
                                <el-button size="small" @click="resetCourseFilter">重置</el-button>
                            </el-form-item>
                        </el-form>
                    </div>

                    <div class="card">
                        <div class="flex-row">
                            <div class="flex-2">
                                <div class="course-list-header">
                                    <span>课程列表</span>
                                </div>
                                <el-table
                                        :data="courses"
                                        stripe
                                        highlight-current-row
                                        @current-change="handleCourseRowClick"
                                        style="width: 100%">
                                    <el-table-column prop="courseCode" label="课程代码" width="120"></el-table-column>
                                    <el-table-column prop="courseName" label="课程名称" min-width="180"></el-table-column>
                                    <el-table-column prop="credit" label="学分" width="80"></el-table-column>
                                    <el-table-column label="余量" width="120">
                                        <template slot-scope="scope">
                                            <span>{{ getRemain(scope.row) }}</span>
                                            <span style="color:#909399;"> / {{ scope.row.maxStudents || 0 }}</span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="semester" label="学期" width="130"></el-table-column>
                                    <el-table-column label="教师" width="120">
                                        <template slot-scope="scope">
                                            <span>{{ getTeacherName(scope.row) }}</span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="操作" width="140">
                                        <template slot-scope="scope">
                                            <el-button
                                                    type="text"
                                                    size="mini"
                                                    @click.stop="openCourseDetail(scope.row)">详情</el-button>
                                            <el-button
                                                    type="primary"
                                                    size="mini"
                                                    :disabled="!canSelectCourse(scope.row)"
                                                    @click.stop="selectCourse(scope.row)">
                                                选课
                                            </el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                            <div class="flex-1">
                                <div style="font-weight:500;margin-bottom:8px;">课程详情</div>
                                <div class="card" style="padding:12px;">
                                    <div v-if="selectedCourse" style="margin-bottom:10px;">
                                        <div style="font-weight:600;">
                                            {{ selectedCourse.courseCode }} · {{ selectedCourse.courseName }}
                                        </div>
                                        <div class="sub-title" style="margin-top:4px;">
                                            学期：{{ selectedCourse.semester || '-' }} · 学分：{{ selectedCourse.credit || '-' }}
                                        </div>
                                    </div>
                                    <div v-if="selectedCourseTeacher" style="display:flex;align-items:center;margin-bottom:10px;">
                                        <div style="width:38px;height:38px;border-radius:50%;background:#f2f6fc;color:#606266;display:flex;align-items:center;justify-content:center;font-weight:700;">
                                            {{ (selectedCourseTeacher.realName || 'T').toString().slice(0, 1) }}
                                        </div>
                                        <div style="margin-left:10px;">
                                            <div style="font-weight:600;">
                                                {{ selectedCourseTeacher.realName || '-' }}
                                                <span class="sub-title" v-if="selectedCourseTeacher.teacherCode">（{{ selectedCourseTeacher.teacherCode }}）</span>
                                            </div>
                                            <div class="sub-title">
                                                邮箱：{{ selectedCourseTeacher.email || '-' }} · 办公室：{{ selectedCourseTeacher.office || '-' }}
                                            </div>
                                            <div class="sub-title">
                                                院系：{{ selectedCourseTeacher.department || '-' }} · 职称：{{ selectedCourseTeacher.title || '-' }}
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else class="sub-title" style="margin-bottom:10px;">
                                        请选择课程以查看任课教师信息。
                                    </div>
                                    <div style="font-weight:500;margin:10px 0 8px;">课程简介</div>
                                    <div id="course-desc-preview" class="course-desc-preview">
                                        <div class="sub-title">请选择左侧课程查看简介（Markdown 富文本只读）。</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 已选课程 -->
                <section v-if="activeTab === 'myCourses'">
                    <div class="page-header">
                        <div>
                            <div class="page-title">
                                <i class="el-icon-reading"></i>
                                已选课程
                            </div>
                            <div class="sub-title">
                                查看和管理自己的选课记录，仅允许退课，不允许修改课程信息。
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <el-table :data="mySelections" stripe style="width: 100%">
                            <el-table-column label="课程名称" min-width="180">
                                <template slot-scope="scope">
                                    {{ getCourseName(scope.row.courseId) }}
                                </template>
                            </el-table-column>
                            <el-table-column prop="status" label="状态" width="100"></el-table-column>
                            <el-table-column prop="finalScore" label="成绩" width="100">
                                <template slot-scope="scope">
                                    <span v-if="scope.row.finalScore != null">{{ scope.row.finalScore }}</span>
                                    <span v-else class="sub-title">未发布</span>
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" width="120">
                                <template slot-scope="scope">
                                    <el-button type="text" size="mini"
                                               @click="dropCourse(scope.row)">退课</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>
                </section>

                <!-- 作业与提交 -->
                <section v-if="activeTab === 'assignments'">
                    <div class="page-header">
                        <div>
                            <div class="page-title">
                                <i class="el-icon-edit-outline"></i>
                                作业与提交
                            </div>
                            <div class="sub-title">
                                查看自己选课下的作业，按提交/打分状态筛选，并完成作业提交或更新。
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <el-form :inline="true" :model="assignmentFilter" label-width="80px">
                            <el-form-item label="课程">
                                <el-select v-model="assignmentFilter.courseId" clearable placeholder="全部课程" size="small" style="width: 200px;">
                                    <el-option
                                            v-for="c in myCourseOptions"
                                            :key="c.id"
                                            :label="c.courseName"
                                            :value="c.id">
                                    </el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item label="提交状态">
                                <el-select v-model="assignmentFilter.submitted" size="small" style="width: 150px;">
                                    <el-option label="全部" :value="null"></el-option>
                                    <el-option label="仅已提交" :value="true"></el-option>
                                    <el-option label="仅未提交" :value="false"></el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item label="评分状态">
                                <el-select v-model="assignmentFilter.graded" size="small" style="width: 150px;">
                                    <el-option label="全部" :value="null"></el-option>
                                    <el-option label="仅已打分" :value="true"></el-option>
                                    <el-option label="仅未打分" :value="false"></el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" size="small" @click="loadAssignments">筛选</el-button>
                            </el-form-item>
                        </el-form>
                    </div>

                    <div class="card">
                        <el-table :data="assignments" stripe style="width: 100%">
                            <el-table-column prop="assignmentTitle" label="作业标题" min-width="200"></el-table-column>
                            <el-table-column label="课程" min-width="160">
                                <template slot-scope="scope">
                                    {{ getCourseName(scope.row.courseId) }}
                                </template>
                            </el-table-column>
                            <el-table-column prop="deadline" label="截止时间" min-width="180">
                                <template slot-scope="scope">
                                    {{ formatDateTime(scope.row.deadline) }}
                                </template>
                            </el-table-column>
                            <el-table-column label="提交状态" width="120">
                                <template slot-scope="scope">
                                    <el-tag size="mini" :type="scope.row.submitted ? 'success' : 'info'">
                                        {{ scope.row.submitted ? '已提交' : '未提交' }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="评分状态" width="120">
                                <template slot-scope="scope">
                                    <el-tag size="mini" :type="scope.row.graded ? 'success' : 'warning'">
                                        {{ scope.row.graded ? '已打分' : '未打分' }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="score" label="得分" width="100">
                                <template slot-scope="scope">
                                    <span v-if="scope.row.score != null">{{ scope.row.score }}</span>
                                    <span v-else class="sub-title">-</span>
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" width="160">
                                <template slot-scope="scope">
                                    <el-button
                                            v-if="!scope.row.submitted"
                                            type="primary"
                                            size="mini"
                                            @click="openSubmitDialog(scope.row)">
                                        提交作业
                                    </el-button>
                                    <el-button
                                            v-else
                                            type="text"
                                            size="mini"
                                            @click="openSubmitDialog(scope.row)">
                                        更新提交
                                    </el-button>
                                    <el-button
                                            v-if="scope.row.submitted && scope.row.submissionId"
                                            type="text"
                                            size="mini"
                                            @click="downloadMyAttachment(scope.row)">
                                        下载附件
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>

                    <!-- 作业提交对话框 -->
                    <el-dialog
                            :title="currentAssignmentRow && currentAssignmentRow.submitted ? '更新作业提交' : '提交作业'"
                            :visible.sync="submitDialogVisible"
                            width="40%">
                        <el-form label-width="80px">
                            <el-form-item label="作业">
                                <span>{{ currentAssignmentRow ? currentAssignmentRow.assignmentTitle : '' }}</span>
                            </el-form-item>
                            <el-form-item label="说明">
                                <el-input
                                        type="textarea"
                                        rows="4"
                                        v-model="submitForm.submissionText"
                                        placeholder="可填写作业说明或答案摘要"></el-input>
                            </el-form-item>
                            <el-form-item label="附件">
                                <input type="file" @change="handleFileChange">
                            </el-form-item>
                        </el-form>
                        <span slot="footer" class="dialog-footer">
                            <el-button @click="submitDialogVisible = false">取 消</el-button>
                            <el-button type="primary" @click="submitAssignment">提 交</el-button>
                        </span>
                    </el-dialog>
                </section>

                <!-- 通知中心 -->
                <section v-if="activeTab === 'notifications'">
                    <div class="page-header">
                        <div>
                            <div class="page-title">
                                <i class="el-icon-bell"></i>
                                通知中心
                            </div>
                            <div class="sub-title">
                                选课成功 / 退课 / 成绩发布 等通知。
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div style="font-weight:500;margin-bottom:8px;">通知列表</div>
                        <el-timeline v-if="notifications.length">
                            <el-timeline-item
                                    v-for="n in notifications"
                                    :key="n.id"
                                    :timestamp="n.publishTime || ''">
                                <div style="font-weight:500;">{{ n.title }}</div>
                                <div style="font-size:13px;color:#606266;margin-top:4px;">{{ n.content }}</div>
                            </el-timeline-item>
                        </el-timeline>
                        <div v-else class="sub-title">暂无通知。</div>

                    </div>
                </section>

                <!-- 个人资料 -->
                <section v-if="activeTab === 'profile'">
                    <div class="page-header">
                        <div>
                            <div class="page-title">
                                <i class="el-icon-user"></i>
                                个人资料
                            </div>
                            <div class="sub-title">
                                查看并更新个人信息和学籍信息（不会删除数据库记录）。
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <el-form :model="profileForm" label-width="100px" style="max-width: 600px;">
                            <el-form-item label="登录账号">
                                <el-input v-model="profileForm.username" disabled></el-input>
                            </el-form-item>
                            <el-form-item label="姓名">
                                <el-input v-model="profileForm.realName"></el-input>
                            </el-form-item>
                            <el-form-item label="邮箱">
                                <el-input v-model="profileForm.email"></el-input>
                            </el-form-item>
                            <el-form-item label="手机号">
                                <el-input v-model="profileForm.phone"></el-input>
                            </el-form-item>
                            <el-form-item label="学号">
                                <el-input v-model="profileForm.studentId"></el-input>
                            </el-form-item>
                            <el-form-item label="专业">
                                <el-input v-model="profileForm.major"></el-input>
                            </el-form-item>
                            <el-form-item label="班级">
                                <el-input v-model="profileForm.className"></el-input>
                            </el-form-item>
                            <el-form-item label="入学年份">
                                <el-input-number v-model="profileForm.enrollmentYear" :min="2000" :max="2100"></el-input-number>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" @click="updateProfile">保存资料</el-button>
                            </el-form-item>
                        </el-form>
                    </div>
                </section>
            </el-main>
        </el-container>
</div>

<script>
    const studentMessages = {
	        zh: {
	            app: { brand: 'webdev' },
	            common: { notLoggedIn: '未登录' },
	            student: {
	                headerSub: '学生端',
	                notifications: '通知',
	                menuProfile: '个人中心',
	                menuLogout: '退出登录',
	                navCourses: '课程中心',
                navMyCourses: '已选课程',
                navAssignments: '作业与提交',
                navNotifications: '通知中心',
                navProfile: '个人资料'
            }
        },
	        en: {
	            app: { brand: 'webdev' },
	            common: { notLoggedIn: 'Not signed in' },
	            student: {
	                headerSub: 'Student',
	                notifications: 'Notifications',
	                menuProfile: 'Profile',
	                menuLogout: 'Sign out',
	                navCourses: 'Courses',
                navMyCourses: 'My courses',
                navAssignments: 'Assignments',
                navNotifications: 'Notifications',
                navProfile: 'Profile'
            }
        }
    };

    const studentLocale = localStorage.getItem('webdev_locale') || 'zh';
    const studentI18n = new VueI18n({
        locale: studentLocale,
        messages: studentMessages
    });

    // 与 teacher.html 一致：所有接口统一加 /api 前缀
    axios.defaults.baseURL = '/api';

    new Vue({
        el: '#app',
        i18n: studentI18n,
        data() {
            return {
                locale: studentLocale,
                activeTab: 'courses',
                currentUser: null,

                // 学生档案
                currentStudent: null,

                // 课程中心
                courses: [],
                coursesAll: [],
                courseTeacherMap: {},
                selectedCourseTeacher: null,
                courseFilter: {
                    semester: '',
                    minCredit: null,
                    maxCredit: null,
                    minRemain: null,
                    sortBy: 'time',
                    sortOrder: 'desc'
                },
                selectedCourse: null,

                // 已选课程
                mySelections: [],

                // 作业
                assignments: [],
                assignmentFilter: {
                    courseId: null,
                    submitted: null,
                    graded: null
                },
                submitDialogVisible: false,
                currentAssignmentRow: null,
                submitForm: {
                    submissionText: '',
                    file: null
                },

                // 通知
                notifications: [],
                unreadNotificationCount: 0,
                ws: null,
                wsStatus: '未连接',

                // 个人中心
                profileForm: {
                    userId: null,
                    username: '',
                    realName: '',
                    email: '',
                    phone: '',
                    studentId: '',
                    className: '',
                    major: '',
                    enrollmentYear: null
                }
            };
        },
        computed: {
            myCourseOptions() {
                const courseIds = this.mySelections.map(s => s.courseId);
                const unique = Array.from(new Set(courseIds));
                const pool = (this.coursesAll && this.coursesAll.length > 0) ? this.coursesAll : this.courses;
                return pool.filter(c => unique.includes(c.id));
            }
        },
        filters: {
            ellipsis(value, length) {
                if (!value) return '';
                if (value.length <= length) return value;
                return value.substr(0, length) + '...';
            }
        },
        methods: {
            switchLocale(lang) {
                this.locale = lang;
                this.$i18n.locale = lang;
                localStorage.setItem('webdev_locale', lang);
            },
            switchTab(tab) {
                this.activeTab = tab;
            },
            handleMenuSelect(index) {
                this.activeTab = index;
            },

            // 课程余量
            getRemain(course) {
                const max = course.maxStudents || 0;
                const cur = course.currentStudents || 0;
                return Math.max(max - cur, 0);
            },
            getCourseStatusTagType(status) {
                if (!status) return 'success';
                const s = status.toUpperCase();
                if (s === 'OPEN') return 'success';
                if (s === 'CLOSED') return 'danger';
                return 'info';
            },

            // 加载当前登录用户和学生档案
            loadCurrentUser() {
                axios.get('/user/me').then(res => {
                    const body = res.data || {};
                    if (body.success) {
                        this.currentUser = body.data;
                        this.profileForm.userId = this.currentUser.id;
                        this.profileForm.username = this.currentUser.username;
                        this.profileForm.realName = this.currentUser.realName || '';
                        this.profileForm.email = this.currentUser.email || '';
                        this.profileForm.phone = this.currentUser.phone || '';
                        this.loadAllCourses();
                        this.loadCourses();
                        this.loadNotifications();
                        this.loadStudentProfile().then(() => {
                            this.loadMySelections();
                            this.loadAssignments();
                        });
                    } else {
                        this.$message.error(body.message || '请先登录');
                    }
                }).catch(() => {
                    this.$message.error('获取当前用户失败');
                });
            },

            loadStudentProfile() {
                return axios.get('/student/me').then(res => {
                    const body = res.data || {};
                    if (body.success) {
                        this.currentStudent = body.data;
                        this.profileForm.studentId = body.data.studentId || '';
                        this.profileForm.className = body.data.className || '';
                        this.profileForm.major = body.data.major || '';
                        this.profileForm.enrollmentYear = body.data.enrollmentYear || null;
                    } else if (body.message) {
                        this.$message.error(body.message);
                    }
                });
            },

            // 课程中心：搜索和加载
            loadCourses() {
                // 默认按搜索条件加载
                this.searchCourses();
            },
            loadAllCourses() {
                axios.get('/course/listAll').then(res => {
                    const body = res.data || {};
                    if (body.success) {
                        this.coursesAll = body.data || [];
                    }
                }).catch(() => {
                });
            },
            normalizeCourseSearchRequest() {
                const minCredit = this.courseFilter.minCredit != null ? Number(this.courseFilter.minCredit) : null;
                const maxCredit = this.courseFilter.maxCredit != null ? Number(this.courseFilter.maxCredit) : null;
                const minRemain = this.courseFilter.minRemain != null ? Number(this.courseFilter.minRemain) : null;
                return {
                    semester: this.courseFilter.semester || null,
                    minCredit: minCredit != null && minCredit > 0 ? minCredit : null,
                    maxCredit: maxCredit != null && maxCredit > 0 ? maxCredit : null,
                    minRemain: minRemain != null && minRemain > 0 ? minRemain : null,
                    sortBy: this.courseFilter.sortBy,
                    sortOrder: this.courseFilter.sortOrder
                };
            },
            searchCourses() {
                const req = this.normalizeCourseSearchRequest();
                axios.post('/course/search', req).then(res => {
                    const body = res.data || {};
                    if (body.success) {
                        const list = body.data || [];
                        // 学生选课中心只展示开放课程
                        this.courses = list.filter(c => String((c && c.status) || '').toUpperCase() === 'OPEN');
                        this.prefetchTeacherInfo(this.courses);
                    } else if (body.message) {
                        this.$message.error(body.message);
                    }
                });
            },
            resetCourseFilter() {
                this.courseFilter = {
                    semester: '',
                    minCredit: null,
                    maxCredit: null,
                    minRemain: null,
                    sortBy: 'time',
                    sortOrder: 'desc'
                };
                this.loadCourses();
            },
            handleCourseRowClick(row) {
                this.selectedCourse = row;
                this.selectedCourseTeacher = row && row.id != null ? (this.courseTeacherMap[row.id] || null) : null;
                if (row && row.id != null) {
                    this.loadCourseDetail(row.id);
                } else {
                    this.renderCourseDescription(row);
                }
            },
            renderCourseDescription(course) {
                const el = document.getElementById('course-desc-preview');
                if (!el) return;
                const raw = course && course.description != null ? course.description : '';
                const content = (typeof raw === 'string' && raw.trim() !== '') ? raw : '暂无课程简介。';
                if (window.Vditor && typeof Vditor.preview === 'function') {
                    Vditor.preview(el, content, {markdown: {toc: true}});
                    return;
                }
                el.textContent = content;
            },
            openCourseDetail(course) {
                this.selectedCourse = course;
                this.selectedCourseTeacher = course && course.id != null ? (this.courseTeacherMap[course.id] || null) : null;
                if (course && course.id != null) {
                    this.loadCourseDetail(course.id);
                } else {
                    this.renderCourseDescription(course);
                }
            },
            loadCourseDetail(courseId) {
                axios.get('/course/' + courseId).then(res => {
                    const body = res.data || {};
                    if (body.success) {
                        this.selectedCourse = body.data || this.selectedCourse;
                    }
                    this.renderCourseDescription(this.selectedCourse);
                    this.loadCourseTeacherInfo(courseId);
                }).catch(() => {
                    this.renderCourseDescription(this.selectedCourse);
                });
            },
            loadCourseTeacherInfo(courseId) {
                if (!courseId) return;
                axios.get('/course/teacherInfo', {params: {courseId}}).then(res => {
                    const body = res.data || {};
                    if (body.success) {
                        const info = body.data || null;
                        this.$set(this.courseTeacherMap, courseId, info);
                        if (this.selectedCourse && this.selectedCourse.id === courseId) {
                            this.selectedCourseTeacher = info;
                        }
                    }
                }).catch(() => {
                });
            },
            prefetchTeacherInfo(courses) {
                const list = Array.isArray(courses) ? courses : [];
                list.forEach(c => {
                    if (!c || c.id == null) return;
                    if (this.courseTeacherMap[c.id]) return;
                    this.loadCourseTeacherInfo(c.id);
                });
            },
            getTeacherName(course) {
                if (!course || course.id == null) return '-';
                const info = this.courseTeacherMap[course.id];
                return info && info.realName ? info.realName : '-';
            },

            // 选课相关
            canSelectCourse(course) {
                if (!course) return false;
                if (!this.currentStudent) return false;
                if (String(course.status || '').toUpperCase() !== 'OPEN') return false;
                const remain = this.getRemain(course);
                if (remain <= 0) return false;
                // 简单禁止重复选课：如果已在 mySelections 中，则禁用
                const exists = this.mySelections.some(s => s.courseId === course.id);
                return !exists;
            },
            selectCourse(course) {
                if (!this.currentStudent) {
                    this.$message.error('未获取到学生档案，无法选课');
                    return;
                }
                this.$confirm(`确定选择课程《${course.courseName}》吗？`, '选课', {
                    type: 'info'
                }).then(() => {
                    const payload = {
                        studentId: this.currentStudent.id,
                        courseId: course.id,
                        status: 'SELECTED'
                    };
                    axios.post('/courseSelection/add', payload).then(res => {
                        const body = res.data || {};
                        if (body.success) {
                            this.$message.success('选课成功');
                            this.loadMySelections();
                        } else {
                            this.$message.error(body.message || '选课失败');
                        }
                    });
                }).catch(() => {
                });
            },
            dropCourse(selection) {
                this.$confirm('确定退选该课程吗？', '退课', {
                    type: 'warning'
                }).then(() => {
                    axios.delete('/courseSelection/' + selection.id).then(res => {
                        const body = res.data || {};
                        if (body.success) {
                            this.$message.success('退课成功');
                            this.loadMySelections();
                        } else {
                            this.$message.error(body.message || '退课失败');
                        }
                    });
                }).catch(() => {
                });
            },
            loadMySelections() {
                if (!this.currentStudent) return;
                axios.get('/courseSelection/listByStudent', {
                    params: {studentId: this.currentStudent.id}
                }).then(res => {
                    const body = res.data || {};
                    if (body.success) {
                        this.mySelections = body.data || [];
                    } else {
                        this.mySelections = [];
                        if (body.message) {
                            this.$message.error(body.message);
                        }
                    }
                });
            },
            getCourseName(courseId) {
                const pool = (this.coursesAll && this.coursesAll.length > 0) ? this.coursesAll : this.courses;
                const c = pool.find(c => c.id === courseId) || this.courses.find(c => c.id === courseId);
                return c ? c.courseName : `课程#${courseId}`;
            },

            // 作业相关
            loadAssignments() {
                if (!this.currentStudent) return;
                const rawCourseId = this.assignmentFilter.courseId;
                const courseId = rawCourseId == null || rawCourseId === ''
                    ? null
                    : (isNaN(Number(rawCourseId)) ? null : Number(rawCourseId));
                const params = {
                    studentId: this.currentStudent.id,
                    courseId: courseId,
                    submitted: this.assignmentFilter.submitted,
                    graded: this.assignmentFilter.graded
                };
                axios.get('/assignmentSubmission/studentFilter', {params}).then(res => {
                    const body = res.data || {};
                    if (body.success) {
                        this.assignments = body.data || [];
                    } else {
                        this.assignments = [];
                        if (body.message) {
                            this.$message.error(body.message);
                        }
                    }
                });
            },
            formatDateTime(value) {
                if (!value) return '';
                // value 可能是 ISO 字符串，简单截取
                return String(value).replace('T', ' ').substr(0, 16);
            },
            openSubmitDialog(row) {
                this.currentAssignmentRow = row;
                this.submitForm.submissionText = '';
                this.submitForm.file = null;
                this.submitDialogVisible = true;
            },
            handleFileChange(e) {
                const files = e.target.files;
                if (files && files.length > 0) {
                    this.submitForm.file = files[0];
                } else {
                    this.submitForm.file = null;
                }
            },
            getSafeUploadFileName(file, fallbackBase) {
                if (!file) return (fallbackBase || 'file') + '.bin';
                const name = String(file.name || '').trim();
                if (name && name.includes('.')) return name;
                const type = String(file.type || '').toLowerCase();
                const map = {
                    'image/png': 'png',
                    'image/jpeg': 'jpg',
                    'image/jpg': 'jpg',
                    'image/gif': 'gif',
                    'image/webp': 'webp',
                    'application/pdf': 'pdf',
                    'application/zip': 'zip',
                    'application/x-zip-compressed': 'zip',
                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'docx',
                    'application/msword': 'doc',
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'xlsx',
                    'application/vnd.ms-excel': 'xls',
                    'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'pptx',
                    'application/vnd.ms-powerpoint': 'ppt'
                };
                const ext = map[type] || 'bin';
                return (fallbackBase || 'upload') + '.' + ext;
            },
            submitAssignment() {
                if (!this.currentAssignmentRow || !this.currentStudent) {
                    this.$message.error('缺少作业或学生信息');
                    return;
                }
                if (!this.submitForm.file) {
                    this.$message.error('请选择要上传的附件');
                    return;
                }

                const formData = new FormData();
                const isUpdate = !!this.currentAssignmentRow.submissionId;
                const url = isUpdate ? '/assignmentSubmission/update' : '/assignmentSubmission/submit';
                const safeName = this.getSafeUploadFileName(this.submitForm.file, 'submission');

                if (isUpdate) {
                    formData.append('id', this.currentAssignmentRow.submissionId);
                    formData.append('submissionText', this.submitForm.submissionText || '');
                    formData.append('file', this.submitForm.file, safeName);
                } else {
                    formData.append('assignmentId', this.currentAssignmentRow.assignmentId);
                    formData.append('studentId', this.currentStudent.id);
                    formData.append('submissionText', this.submitForm.submissionText || '');
                    formData.append('file', this.submitForm.file, safeName);
                }

                axios.post(url, formData).then(res => {
                    const body = res.data || {};
                    if (body.success) {
                        this.$message.success(isUpdate ? '更新提交成功' : '提交成功');
                        this.submitDialogVisible = false;
                        this.loadAssignments();
                    } else {
                        this.$message.error(body.message || (isUpdate ? '更新失败' : '提交失败'));
                    }
                }).catch(() => {
                    this.$message.error(isUpdate ? '更新请求失败' : '提交请求失败');
                });
            },

            downloadMyAttachment(row) {
                if (!row || !row.submissionId) {
                    this.$message.error('缺少提交记录');
                    return;
                }
                window.open('/api/assignmentSubmission/downloadAttachment/' + row.submissionId, '_blank');
            },

            // 通知
            loadNotifications() {
                axios.get('/notification/listAll').then(res => {
                    const body = res.data || {};
                    if (body.success) {
                        this.notifications = body.data || [];
                        this.unreadNotificationCount = this.notifications.length;
                    } else if (body.message) {
                        this.$message.error(body.message);
                    }
                });
            },
            initWebSocket() {
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
                try {
                    const url = (location.protocol === 'https:' ? 'wss://' : 'ws://')
                        + location.host + '/ws/notification';
                    this.ws = new WebSocket(url);
                    this.wsStatus = '连接中...';
                    this.ws.onopen = () => {
                        this.wsStatus = '已连接';
                    };
                    this.ws.onmessage = (event) => {
                        // { type: 'ENROLL'|'DROP'|'GRADE'|'SYSTEM', message: '...', time: '...' }
                        try {
                            const msg = JSON.parse(event.data);
                            let title = '新通知';
                            if (msg.type === 'ENROLL') {
                                title = '选课成功';
                            } else if (msg.type === 'DROP') {
                                title = '退课成功';
                            } else if (msg.type === 'GRADE') {
                                title = '成绩发布';
                            }
                            this.$notify({
                                title: title,
                                message: msg.message || '有新的选课/成绩变动',
                                type: 'info'
                            });
                            this.unreadNotificationCount += 1;
                            this.loadNotifications();
                        } catch (e) {
                            console.log('WS message:', event.data);
                        }
                    };
                    this.ws.onclose = () => {
                        this.wsStatus = '未连接';
                    };
                    this.ws.onerror = () => {
                        this.wsStatus = '连接出错';
                    };
                } catch (e) {
                    this.wsStatus = '浏览器不支持 WebSocket';
                }
            },

            // 个人中心
            updateProfile() {
                if (!this.profileForm.userId) {
                    this.$message.error('未获取到用户ID');
                    return;
                }
                const req = {
                    userId: this.profileForm.userId,
                    realName: this.profileForm.realName,
                    email: this.profileForm.email,
                    phone: this.profileForm.phone,
                    studentId: this.profileForm.studentId,
                    className: this.profileForm.className,
                    major: this.profileForm.major,
                    enrollmentYear: this.profileForm.enrollmentYear
                };
                axios.post('/student/updateProfile', req).then(res => {
                    const body = res.data || {};
                    if (body.success) {
                        this.$message.success('个人资料已更新');
                        this.loadCurrentUser();
                    } else {
                        this.$message.error(body.message || '更新失败');
                    }
                });
            },

            // 退出登录
            logout() {
                axios.post('/user/logout').then(() => {
                    this.currentUser = null;
                    this.$message.success('已退出登录');
                    window.location.href = '/login.html';
                });
            }
        },
        mounted() {
            this.loadCurrentUser();
        }
    });
</script>
</body>
</html>
